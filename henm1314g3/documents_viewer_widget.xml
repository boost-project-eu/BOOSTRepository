<?xml version="1.0" encoding="UTF-8" ?>
<Module>
    
    <ModulePrefs title="Boost Viewer"
		description="View documents like videos or slides."
		author="Team Boost"
		author_email="henm1314g3@dbis.rwth-aachen.de"
		width="600"
		height="400">
  	<Require feature="opensocial-0.8" />
    <Require feature="openapp" />
    <OAuth>
		<Service name="openapp"                     
		    xmlns:openapp="http://www.role-project.eu/xml/openapp/opensocialext/" 
		    openapp:service="http://purl.org/role/terms/spaceService"
		    openapp:permitReadAppend="http://purl.org/role/terms/data">
			
		    <Request method="" url=""/>
			<Authorization url=""/>
			<Access method="" url=""/>
		</Service>
    </OAuth>
    </ModulePrefs>
    
    <Content type="html">
    <![CDATA[
		
		<!-- We use jQuery to manipulate DOM and jQuery-UI for the interface. -->
    	<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/jquery-1.10.2.min.js" type="text/javascript"></script>
    	<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/bootstrap.min.js" type="text/javascript"></script>
    	<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/search_youtube.js" type="text/javascript"></script>
    	<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/search_slideshare.js" type="text/javascript"></script>
    	<script src="https://apis.google.com/js/client.js?onload=onYouTubeClientLoad" type="text/javascript"></script>
    	<script src="http://dbis.rwth-aachen.de/gadgets/iwc/lib/iwc.js"></script>
    	<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/linkify.js" type="text/javascript"></script>
    	<script type="text/javascript" src='http://www.scribd.com/javascripts/scribd_api.js'></script>

    	<!-- Config stuff -->
 		<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/async.js"></script>
 		<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/boostShared.js"></script>
 		<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/repositories.js"></script>
    	<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/ConfigManager.js"></script>


		<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/AccessRightsManager.js" type="text/javascript"></script>
		<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/bootbox.min.js"></script>
		<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/UserManager.js"></script>
	

		<!-- Define CSS -->		
		<link href="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/css/bootstrap.min.css" rel="stylesheet">

		<!-- JavaScript Block -->
		<script>
			var iwcClient;
			var userAccessRights;
			var userList;
			var space;
			
			gadgets.util.registerOnLoadHandler(init);
			
			function init(){
				space = new openapp.oo.Resource(openapp.param.space());
				iwcClient = new iwc.Client();
				iwcClient.connect(iwcCallback);
			}

			function iwcCallback(intent){
				if(intent.action == "LEARNING_DOCUMENT_SELECTED" ||
					intent.action == "SHOW_LEARNING_DOCUMENT"){
					var document = intent.extras;
					if(document.type == "youtube")
						showYoutubeVideo(document.contentSpecificData.videoId);
					if(document.type == "slideshare")
						showSlideshareSlideshow(document.contentSpecificData.id);
					if(document.type == "scribd")
						showScribdDocument(document.contentSpecificData.id, document.contentSpecificData.accessKey, document.description);
				}

				if(intent.action == "SHOW_YOUTUBE_VIDEO"){
					showYoutubeVideo(intent.extras.id);
				}

				if(intent.action == "SHOW_SLIDESHARE_SLIDESHOW"){
					showSlideshareSlideshow(intent.extras.id);
				}

				if(intent.action == "SHOW_SCRIBD_DOCUMENT"){
					showScribdDocument(intent.extras.id, intent.extras.accessKey, intent.extras.description);
				}
			}

			function showYoutubeVideo(id){
				$("#content").empty();
				//Retrieve video data
				YouTubeSearch.getVideoDetails(id, function(videoDetails){
					var title = videoDetails.items[0].snippet.description;
					var description = videoDetails.items[0].snippet.description;
					var youtubeTemplate = 	"<div class='well'>" +
											"<center>" +
											"<div>" +
											"<iframe type='text/html' width='480' height='270' src='https://www.youtube.com/embed/" + id + "' " +
		                                    "frameborder='0' allowfullscreen></iframe>" +
				                        	"</div>" +
		                                    "</center>" +
				                        	"<h4>Description</h4>" +
				                        	"<p>" +
				                        		description.replace(/\n/g, "<br>").linkify() +
				                        	"</p>" +
				                        	"</div>";
				    var $youtubeElement = $(youtubeTemplate);
				    //If the user clicks on a link, open a new tab in the browser
				    assignLinkClickEvents($youtubeElement);
				    $("#content").append($youtubeElement);
				});
			}

			function showSlideshareSlideshow(id){
				$("#content").empty();
				SlideShareSearch.getSlideshowDetails(id, function(slideshowDetails){
					var description = slideshowDetails.Slideshow.Description;
					if(!description)
						description = "No description available.";
					var slideshowTemplate =	"<div class='well'>" +
											"<center>" +
											slideshowDetails.Slideshow.Embed +
		                                    "</center>" +
				                        	"<h4>Description</h4>" +
				                        	"<p>" +
				                        		description.replace(/\n/g, "<br>").linkify() +
				                        	"</p>" +
				                        	"</div>";

				    var $slideShowElement = $(slideshowTemplate);
                	//If the user clicks on a link, open a new tab in the browser
				    assignLinkClickEvents($slideShowElement);
				    $("#content").append($slideShowElement);
				});
			}

			function showScribdDocument(id, accessKey, description){
				$("#content").empty();
				var scribdTemplate = 	"<div class='well'>" +
										"<div id='scribdContainer'>" +
	                                    "</div>" +
			                        	"<h4>Description</h4>" +
			                        	"<p>" +
			                        		description.replace(/\n/g, "<br>").linkify() +
			                        	"</p>" +
			                        	"</div>";
			    
			    var $scribdElement = $(scribdTemplate);
			    //If the user clicks on a link, open a new tab in the browser
			    assignLinkClickEvents($scribdElement);
			    $("#content").append($scribdElement);
			    
			    var scribd_doc = scribd.Document.getDoc(id, accessKey);
				scribd_doc.addParam('jsapi_version', 2);
				scribd_doc.write('scribdContainer');
			}

			function assignLinkClickEvents(element){
				element.find('a').click(function(e){
			    	var url = $(this).attr("href");
			    	window.open(url,'_blank');
			    	//Prevent default click behaviour which opens the link inside the widget
			    	e.preventDefault();
			    });
			}

			$(function(){

			// Get the access rights: 
				retrieveAccessRights(function(accessRights){
				 userAccessRights = accessRights.getUserAccessRights();
					
					//Check if user has agreed to license
	
					if(!userAccessRights.hasAgreedToLicense){
							showModalAcceptTermsOfUse();							
					}
			
			      // help button click 

			      $('#question').click(function(){
			        $('#descriptionModal').modal({
			        keyboard: true
			          });
			        }); 
			});
		});



		</script>

		<!-- HTML Block -->
		<div style="overflow-y: scroll; height:400px;">
		<div class="panel panel-primary">
			<div class="panel-heading">
				<button id="question" type="button" class="btn btn-default launch-modal" style="float:right; margin:-5 5 10 5px; color:#428BCA;"><span  class="glyphicon glyphicon-question-sign"></span></button>
				<h3 class="panel-title"><span class="glyphicon glyphicon-play-circle" style="margin-right:5px;"></span>Documents viewer</h3>
		  	</div>
		  	<div class="panel-body" id="content">
			</div>
		</div>
		</div>

		 <div class="modal fade" id="descriptionModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Boost Viewer Help</h4>
            </div>
          <div class="modal-body">
            <div class="panel-group" id="levelsdef" align="justify">
            <ul style="padding: 10px;">
             <li>Click on learning document in <i>Boost Search</i> or <i>Learning Repository</i> widget to see it in <i>Boost Viewer</i></li>
              </li>
            </ul>         
          </div>
          <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>          
          </div>      
        </div>      
      </div>
    </div>
	]]>
  </Content>
</Module>

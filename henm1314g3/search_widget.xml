<?xml version="1.0" encoding="UTF-8" ?>
<Module>
    
    <ModulePrefs title="Boost Search"
		description="Widget to search learning material."
		author="Team Boost"
		author_email="henm1314g3@dbis.rwth-aachen.de"
		height="400">
  	<Require feature="opensocial-0.8" />
    <Require feature="openapp" />
    <OAuth>
		<Service name="openapp"                     
		    xmlns:openapp="http://www.role-project.eu/xml/openapp/opensocialext/" 
		    openapp:service="http://purl.org/role/terms/spaceService"
		    openapp:permitReadAppend="http://purl.org/role/terms/data">
			
		    <Request method="" url=""/>
			<Authorization url=""/>
			<Access method="" url=""/>
		</Service>
    </OAuth>
    </ModulePrefs>
    
    <Content type="html">
    <![CDATA[
		
		<!-- We use jQuery to manipulate DOM and jQuery-UI for the interface. -->
    	<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/jquery-1.10.2.min.js" type="text/javascript"></script>
    	<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/bootstrap.min.js" type="text/javascript"></script>
    	<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/search_youtube.js" type="text/javascript"></script>
    	<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/search_slideshare.js" type="text/javascript"></script>
    	<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/search_scribd.js" type="text/javascript"></script>
    	<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/linkify.js" type="text/javascript"></script>
    	<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/rivets.min.js" type="text/javascript"></script>
    	<script src="https://apis.google.com/js/client.js?onload=onYouTubeClientLoad" type="text/javascript"></script>
    	<script src="http://dbis.rwth-aachen.de/gadgets/iwc/lib/iwc.js"></script>

 		<!-- Config stuff -->
 		<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/boostShared.js"></script>
    	<script src="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/js/ConfigManager.js"></script>

		<!-- Define CSS -->
		<link href="http://127.0.0.1:8073/role/BOOSTRepository/henm1314g3/css/bootstrap.min.css" rel="stylesheet">

		<!-- JavaScript Block -->
		<script>
		//Globals
		var ITEMS_PER_PAGE = 5;
		var NUM_PAGES = 5;
		var ITEMS_PER_SEARCH = ITEMS_PER_PAGE * NUM_PAGES;
		var repositories = [];
		var model = {};
		model.selectedRepository = null;
		var iwcClient;
		var config;
		var space;
		var searchResultEntryTemplate =    	"<a href='#' class='list-group-item' style='min-height:150px;'>" +
			    								"<img style='margin-right:10px; height:100px;' class='pull-left' src='#imageURL' alt=''>" +
			    								"<h4>#title</h4>" +
	    										"<p>" +
	    											"#description" +
	    										"</p>" +
	    									"</a>";

		gadgets.util.registerOnLoadHandler(init);

		function init(){

			space = new openapp.oo.Resource(openapp.param.space());
			iwcClient = new iwc.Client();
			iwcClient.connect(iwcCallback);
			retrieveConfig(space, function(configObject){
				config = configObject;
     		});
		}

		function addRepository(repository){
			var newRepository = {};
			newRepository.activate = function(){
				model.selectedRepository = newRepository;
			}
			newRepository.index = repositories.length;
			newRepository.searchFunctions = repository;
			newRepository.currentPageIndex = 0;
			newRepository.pageOffset = 1;
			newRepository.searchResults = [];
			newRepository.visibleResults = [];
			newRepository.hasNextPage = false;
			newRepository.hasPrevPage = false;
			newRepository.hasResults = false;
			newRepository.searching = false;

			var updateVisibleResults = function(){
				newRepository.visibleResults = [];
				var maxIndex = newRepository.currentPageIndex * ITEMS_PER_PAGE + ITEMS_PER_PAGE;
				if (maxIndex > newRepository.searchResults.length)
					maxIndex = newRepository.searchResults.length;
				for(var i = newRepository.currentPageIndex * ITEMS_PER_PAGE; 
					i < maxIndex; i++){
					newRepository.visibleResults.push(newRepository.searchResults[i]);
				}
			};

			var createPage =  function(index, offset){
				var page = {};
				page.index = index;
				page.value = index + offset;
				page.isSelected = (index==0);
				page.click = function(event, model){
					newRepository.currentPageIndex = page.index;
					page.isSelected = true;
					for(var i = 0; i < newRepository.pages.length; i++){
						if(i != page.index)
							newRepository.pages[i].isSelected = false;
					}
					updateVisibleResults();
					$("#content").animate({ scrollTop: 0 }, "fast");
				}
				return page;
			}

			var updatePagination = function(){
				newRepository.pages = [];
				for(var i = 0; i < NUM_PAGES ; i++){
					newRepository.pages.push(createPage(i, newRepository.pageOffset));
				}
			};

			newRepository.nextResultsPage = function(){
				this.searching = true;
				this.visibleResults = [];
				newRepository.searchFunctions.nextResultsPage(function(results){
					newRepository.pageOffset += ITEMS_PER_PAGE;
					newRepository.initNewResults(results);
					newRepository.searching = false;
					$("#content").animate({ scrollTop: 0 }, "fast");
				});
			}
			newRepository.prevResultsPage = function(){
				this.searching = true;
				this.visibleResults = [];
				newRepository.searchFunctions.prevResultsPage(function(results){
					newRepository.pageOffset -= ITEMS_PER_PAGE;
					newRepository.initNewResults(results);
					newRepository.searching = false;
					$("#content").animate({ scrollTop: 0 }, "fast");
				});
			}

			newRepository.initNewResults = function(results){
				for(var i = 0; i < results.length; i ++){
					results[i] = processResult(results[i]);
				}
				newRepository.searchResults = results;
				newRepository.currentPageIndex = 0;
				newRepository.hasPrevPage = newRepository.searchFunctions.hasPrevPage();
				newRepository.hasNextPage = newRepository.searchFunctions.hasNextPage();
				newRepository.hasResults = (results.length > 0);
				updatePagination();
				updateVisibleResults();
			}

			var processResult = function(result){
				result.click = function(){
					publishLearningDocumentSelected(result);
				}
				return result;
			}
			newRepository.search = function(query, callback){
				this.searching = true;
				this.visibleResults = [];
				newRepository.searchFunctions.search(query, function(results){
					newRepository.searching = false;
					newRepository.pageOffset = 1;
					newRepository.initNewResults(results);
				});
			}

			newRepository.initNewResults([]);

			//alert(JSON.stringify(newRepository));
			
			repositories.push(newRepository);
		}

		function iwcCallback(intent){
			if (intent.action == "CONFIG_CHANGE"){

			}
			
		}

		function publishLearningDocumentSelected(learningDocument){
			var intent = {
				component: "",
				data: "",
				dataType: "text/json",
				action: "LEARNING_DOCUMENT_SELECTED",
				extras: learningDocument
			};

			iwcClient.publish(intent);
		}

		$(function(){

			 // help button click 

    	  $('#question').click(function(){
        	$('#descriptionModal').modal({
        		keyboard: true
          	});
        	}); 

			//Add new repositories here
			addRepository(new YoutubeSearch(ITEMS_PER_SEARCH));
			addRepository(new SlideshareSearch(ITEMS_PER_SEARCH));
			addRepository(new ScribdSearch(ITEMS_PER_SEARCH));
			
			model.selectedRepository = repositories[0];

			rivets.binders.highlight = function(el, value){
				if(value)
					$(el).addClass("active");
				else
					$(el).removeClass("active");
			}

			rivets.binders.enable = function(el, value){
				if(value)
					$(el).removeClass("disabled");
				else
					$(el).addClass("disabled");
			}

			rivets.bind($("#selectRepositoryButtonGroup").get(), {repositories:repositories});
			rivets.bind($("#resultsList").get(), {model:model});
			rivets.bind($("#pagination").get(),  {model:model});
			rivets.bind($("#progressbar").get(),  {model:model});

			$("#search_button").click(function(){
				model.selectedRepository.search($("#search_field").val(), function(){
					
				});
			});

			$("#search_field").keypress(function(event){
				if(event.which == 13){
					model.selectedRepository.search($("#search_field").val(), function(){
					
				});
				}
			});
		});

		function renderSearchProgressBar(){
				var progressBar =       "<div class='progress progress-striped active'>" +
		                                    "<div class='progress-bar'  role='progressbar' aria-valuenow='1' aria-valuemin='0' aria-valuemax='1' style='width: 100%'>" +
		                                        "<span>Searching...</span>" +
		                                    "</div>" +
		                                "</div>";
		        $("#resultsFooter").empty();
		        $("#resultsFooter").append(progressBar);
		}


		</script>
		
		<!-- HTML Block -->
		<div style="overflow-y: scroll; height:400px;" id="content">
		<div class="panel panel-primary">
			<div class="panel-heading">
				<button id="question" type="button" class="btn btn-default launch-modal" style="float:right; margin:-5 5 10 5px; color:#428BCA;"><span  class="glyphicon glyphicon-question-sign"></span></button>
		    	<h3 class="panel-title"><span class="glyphicon glyphicon-search" style="margin-right:5px;"></span>Search documents</h3>
		  	</div>
		  	<div class="panel-body" id="panelBody">
		  		<div class="input-group" style="padding-top:5px;">
			      <input type="text" id="search_field" class="form-control" placeholder="Enter your search and hit enter or click on 'Go'">
			      <span class="input-group-btn">
			        <button class="btn btn-default" type="button" id="search_button">Go</button>
			      </span>
			    </div>
			    <div id="selectRepositoryButtonGroup" class="btn-group" data-toggle="buttons" style="padding-top:5px;">
				  <button rv-each-repository="repositories" class="btn btn-xs btn-primary">
				    <input rv-on-change="repository.activate" type="radio" name="options">{repository.searchFunctions.name}</input>
				  </button>
				</div>
				<div id="progressbar" style="margin-top:10px;" rv-if="model.selectedRepository.searching" class='progress progress-striped active'>
                	<div class='progress-bar'  role='progressbar' aria-valuenow='1' aria-valuemin='0' aria-valuemax='1' style='width: 100%'>
		            	<span>Searching...</span>
		            </div>
		        </div>
			</div>
			<div class="list-group" id="resultsList">
				<a rv-each-result="model.selectedRepository.visibleResults" rv-on-click="result.click" href='#' class='list-group-item' style='min-height:150px;'>
					<img rv-src="result.contentSpecificData.imageUrl" style='margin-right:10px; height:50px;' class='pull-left' alt=''>
					<h5>{result.name}</h5>
					<p><small>{result.description}</small></p>
				</a>
			</div>
			<div class="panel-footer" id="resultsFooter"></div>
				<center>
					<ul rv-show="model.selectedRepository.hasResults" id="pagination" class='pagination' style='margin-top:5px; margin-bottom:5px;'>
						<li rv-if="model.selectedRepository.hasPrevPage"><a rv-on-click="model.selectedRepository.prevResultsPage" href='#'>&laquo;</a></li>
						<li rv-each-page="model.selectedRepository.pages" rv-highlight="page.isSelected"><a rv-on-click="page.click" href='#'>{page.value}</a></li>
						<li rv-if="model.selectedRepository.hasNextPage"><a rv-on-click="model.selectedRepository.nextResultsPage" href='#'>&raquo;</a></li>
					</ul>
				</center>
			</div>
		</div>
		<div class="modal fade" id="descriptionModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    		<h4 class="modal-title">Search Widget Help</h4>
            </div>
          <div class="modal-body">
            <div class="panel-group" id="levelsdef" align="justify">
            <ul style="padding: 10px;">
            	<li>To choose learning repository click on <i>YouTube</i>, <i>SlideShare</i> or <i>Scribd</i> tabs under the input field.</li>
            	<li>To search learning document enter keywords in the input field and click on the <i>Go</i> button.</li>
            	<li>Trainer can disable or enable access to learning repositories in the <i>Configuration Boost</i> widget.</li>
            	<li>To view learning document click on it. The view will be shown straight away in the <i>Boost Viewer</i> widget.</li>
            </ul>	 	
          </div>
          <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>          
          </div>      
        </div>      
      </div>
    </div>
	]]>
  </Content>
</Module>